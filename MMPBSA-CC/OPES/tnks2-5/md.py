# This script was generated by OpenMM-Setup on 2021-05-08.
from openmm import *
from simtk.openmm.app import *
from simtk.unit import *
from openmmplumed import PlumedForce
from sys import stdout,argv
import mdtraj as md
import numpy as np

# Input Files
pdbfile = "tnks2-5.pdb"
grofile = "tnks2-5.gro"
outfile = "tnks2-5"
gpuid = '1'
topfile = "topol.top"


# Input Files
gro = GromacsGroFile(grofile)
top = GromacsTopFile(topfile, includeDir='/root/miniconda3/envs/openmm_env/share/gromacs/top/',
    periodicBoxVectors=gro.getPeriodicBoxVectors())

# System Configuration
nonbondedMethod = PME
nonbondedCutoff = 1.0*nanometers
ewaldErrorTolerance = 0.0005
constraints = HBonds
rigidWater = True
constraintTolerance = 0.000001
hydrogenMass = 4.0*amu

# Integration Options
dt = 0.004 * picoseconds
temperature = 300*kelvin
friction = 1.0/picosecond
pressure = 1.0*atmospheres
barostatInterval = 25

# Simulation Options
emsteps =       1000       # default
eqsteps =    1250000       # 
mdsteps =  250000000       # 
exsteps =      25000       # 

platform = Platform.getPlatformByName('CUDA')
platformProperties = {'Precision': 'mixed',"DeviceIndex":gpuid}
#platformProperties["DeviceIndex"] = "0"
os.system("export OPENMM_CPU_THREADS=8")

# Output Options
dcdReporter  = DCDReporter(outfile+'.dcd', exsteps)
# pdbReporter  = PDBReporter(outfile+'.pdb', exsteps)
chkReporter  = CheckpointReporter(outfile+'.chk', exsteps*10)
datReporter0 = StateDataReporter(outfile+'.log', exsteps, totalSteps=mdsteps,
               step=True, speed=True, progress=True, potentialEnergy=True, 
               temperature=True,volume=True, separator=',')
datReporter1 = StateDataReporter(stdout, exsteps, step=True,
               time=True, potentialEnergy=True, kineticEnergy=True, totalEnergy=True,
               temperature=True, progress=True, volume=True, density=True,
               remainingTime=True, speed=True, totalSteps=mdsteps, separator=',')
datReporter2 = StateDataReporter(outfile+'.csv', exsteps, step=True,
               time=True, potentialEnergy=True, kineticEnergy=True, totalEnergy=True,
               temperature=True, progress=True, volume=True, density=True,
               remainingTime=True, speed=True, totalSteps=mdsteps, separator=',')

# Prepare the Simulation
print('Building system...')
topology = top.topology
positions = gro.positions
system = top.createSystem(nonbondedMethod=nonbondedMethod, nonbondedCutoff=nonbondedCutoff,
    constraints=constraints, rigidWater=rigidWater, ewaldErrorTolerance=ewaldErrorTolerance, hydrogenMass=hydrogenMass)
barostat = MonteCarloBarostat(pressure, temperature, barostatInterval)
system.addForce(barostat)


traj = md.load(pdbfile)
a = traj.topology.select("(resname L01) and (name C10)")
b = traj.topology.select("(resname L01) and (name C11)")
c = traj.topology.select("(resname L01) and (name N2)")
d = traj.topology.select("(resname L01) and (name C14)")
print(a[0], b[0], c[0], d[0])

plumed_script_1 = f"""
t1: TORSION ATOMS={a[0]+1},{b[0]+1},{c[0]+1},{d[0]+1}
opes: OPES_METAD ARG=t1 PACE=2500 BARRIER=15 TEMP=300
PRINT STRIDE={exsteps} FILE=COLVAR ARG=*
"""
plumed_force = PlumedForce(plumed_script_1)
system.addForce(plumed_force)



print("=================================================================")
integrator = LangevinIntegrator(temperature,friction, dt)
integrator.setConstraintTolerance(constraintTolerance)
simulation = Simulation(topology, system, integrator, platform, platformProperties)
simulation.context.setPositions(positions)

# # Minimize and Equilibrate
print('Performing energy minimization...')
simulation.minimizeEnergy()
# # let's save a PDB of the last frame of the simulation
lastpositions = simulation.context.getState(getPositions=True).getPositions()
PDBFile.writeFile(top.topology, lastpositions, open(outfile+'-em.pdb', 'w'))

# print('Equilibrating...')
# simulation.reporters.append(StateDataReporter(stdout, 1000, step=True, potentialEnergy=True, temperature=True, speed=True, totalSteps=eqsteps, separator='\t'))
# simulation.context.setVelocitiesToTemperature(temperature)
# simulation.step(eqsteps)

# print('Running Simulated Annealing MD')
# # every int(eqsteps/6) steps raise the temperature by 5 K, ending at 300 K
# T = 50*kelvin
# simulation.context.setVelocitiesToTemperature(T)
# for i in range(6):
#     simulation.step( int(eqsteps/6) )
#     integrator.setTemperature(T+(i*T))
#     barostat.setDefaultTemperature(T+(i*T))

# # let's also save a PDB of the last frame of the simulation
# lastpositions = simulation.context.getState(getPositions=True).getPositions()
# PDBFile.writeFile(top.topology, lastpositions, open(outfile+'-eq.pdb', 'w'))

# exit()
# Simulate
print('Simulating...')
simulation.reporters.append(dcdReporter)
simulation.reporters.append(chkReporter)
# simulation.saveCheckpoint('state.chk') # Same like the above!
# simulation.loadCheckpoint('state.chk') # Only for restart !
# Open checkpoint file like the follows better:
# with open("restart.chk",'rb') as f:
#     sim.context.loadCheckpoint(f.read())
# simulation.reporters.append(pdbReporter)
simulation.reporters.append(datReporter0)
simulation.reporters.append(datReporter1)
simulation.reporters.append(datReporter2)
simulation.reporters.append(StateDataReporter(stdout, 50000, step=True, potentialEnergy=True, temperature=True, speed=True, totalSteps=mdsteps, separator=','))
simulation.currentStep = 0
simulation.context.setVelocitiesToTemperature(temperature)
simulation.step(mdsteps)

# let's also save a PDB of the last frame of the simulation
lastpositions = simulation.context.getState(getPositions=True).getPositions()
PDBFile.writeFile(top.topology, lastpositions, open(outfile+'-md.pdb', 'w'))
